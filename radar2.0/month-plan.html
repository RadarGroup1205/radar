<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/layui.css">
    <link rel="stylesheet" href="css/modules/layer/default/layer.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/time.js"></script>
    <script>
        serverUrl = 'http://10.222.6.46:8080/radar_db';
        var userName = sessionStorage.getItem('userName');
        console.log(userName);
        initSelect();

        // 初始化下拉框选项
        function initSelect() {
            try {
                // 清空select列表数据
                $('#subtask,#sSubtask, #status,#sStatus, #staff,#sStaff').empty();
                // Ajax获取动态数据
                $.ajax({
                    url: serverUrl + '/GetMonthDropList',
                    type: 'post',
                    data: {loginName: userName},
                    success: function (data) {
                        data = JSON.parse(data);  // 转换成json对象
                        var subtask = data.subtask;
                        var status = data.status;
                        var staff = data.repairman;
                        if (data) {
                            // 添加第一个option值
                            $('#subtask,#sSubtask, #sStatus, #staff,#sStaff').prepend('<option value="0">--------请选择--------</option>');
                            for (i = 0; i < subtask.length; i++) {
                                $('#subtask,#sSubtask').append('<option value="' + subtask[i] + '">' + subtask[i] + '</option>');
                            };
                            $.each(status, function (i, val) {
                                $('#status,#sStatus').append('<option value="' + val + '">' + val + '</option>');
                            });
                            $.each(staff, function (i, val) {
                                $('#staff,#sStaff').append('<option value="' + val + '">' + val + '</option>');
                            })
                        }
                        else {
                            alert('初始化下拉列表失败！');
                            window.location.reload();
                        }
                    },
                    error: function (msg) {
                        alert('网络连接错误' + JSON.stringify(msg));
                    }
                });
            } catch (error) {
                window.location.reload();
                alert(error.name + error.message);
            }
        }

        // 打开新建模态框
        function addModal() {
            console.log('addPlan');
            // 表单重置
            $('#planForm')[0].reset();
            // 设置模态框标题
            $('#plan h4').text('新增任务计划');
            // 设置表单的action
            $('#planForm').prop('action', serverUrl + '/PlanAdd');
            // 初始化日期输入框
            initDate($('#sDate,#eDate,#cTime'), 1);
            // 弹出模态框
            $('#plan').modal();
        }

        // 打开修改模态框，注意回填
        function editModal(data) {
            console.log('editPlan');
            // 表单重置
            $('#planForm')[0].reset();
            // 设置模态框标题
            $('#plan h4').text('修改任务计划');
            // 设置表单的action
            $('#planForm').prop('action', serverUrl + '/PlanUpdate');
            // 回填表单
            $('#planID').val(data.monthlyScheduleId);
            $('#title').val(data.monthNo);
            $('#subtask').val(data.subtaskNo);
            $('#sDate').val(data.startTime);
            $('#eDate').val(data.endTime);
            $('#staff').val(data.repairman);
            $('#status').val(data.status);
            $('#cTime').val(data.notesTime);
            $('#notes').val(data.notes);
            $('#detail').val(data.plan);
            // 弹出模态框
            $('#plan').modal();
        }

        // 打开查询模态框
        function searchModal() {
            console.log('searchPlan');
            // 表单重置
            $('#sPlanForm')[0].reset();
            // 初始化日期输入框  
            initDate($('#ssDate,#seDate'), 0);
            // 弹出模态框
            $('#sPlan').modal();
        }

        // 提交新建/修改计划
        function submit() {
            var titles = $('#title').val();
            var startTime = $('#sDate').val();
            var endTime = $('#eDate').val();
            //判断导购员名称不能为空
            if (titles != "" && startTime != "" && endTime != "") {
                //加载层
                var load = layer.load();
                $("#planForm").ajaxSubmit(function (returnMsg) {
                    //关闭加载层
                    layer.close(load);
                    if (returnMsg.State) {
                        //layer.msg(returnMsg.Text, { icon: 1, title: "提示" });
                        //关闭模态框
                        $('#plan').modal("hide");
                        //输出
                        layer.alert(returnMsg.Text, { icon: 1, title: "提示" });
                        //刷新表格
                        table.reload('pTable', { where: { user: userName }, page: { curr: 1 } });
                    }
                    else {
                        layer.alert(returnMsg.Text, { icon: 0, title: "提示" });
                    }
                });
            } else {
                layer.alert("请将数据填写完整！", { icon: 0, title: "提示" });
            };
        }
        
        // 查询
        function search() {
            var startTime = $('#ssDate').val();
            var endTime = $('#seDate').val();
        }
        // 删除
        // 监听按钮
        $(document).ready(function () {
            // 提交
            $('#submit').click(function () {
                submit();
            })
            // 搜索
            $('#search').click(function () {
                search();
            })
        })
    </script>

    <style>
        p>label {
            width: 80px;
            text-align: right;
            padding: 5px;
        }

        .modal-dialog {
            width: fit-content;
        }
    </style>
</head>

<body>
    <!-- 页面内容开始 -->
    <table class="layui-hide" id="pTable" lay-filter="pTable"></table>
    <!-- 页面内容结束 -->
    <!-- 弹框内容开始 -->
    <!-- 添加计划 -->
    <div id="plan" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">任务计划</h4>
                </div>
                <div id="planModal" class="modal-body">
                    <form id="planForm" action="" class="form-horizontal">
                        <input id="planID" name="planID" type="text" hidden>
                        <table style="border-collapse:separate; border-spacing:20px 20px;">
                            <tbody>
                                <tr>
                                    <td><label>任务名称:</label></td>
                                    <td><input id="title" name="title" class="form-control" type="text" required
                                            placeholder="任务名称"></td>
                                    <td><label>归属任务:</label></td>
                                    <td><select id="subtask" name="subtaskNo" class="form-control"></select></td>
                                </tr>
                                <tr>
                                    <td><label>开始时间:</label></td>
                                    <td><input id="sDate" name="startTime" class="form-control" type="date" required>
                                    </td>
                                    <td><label>结束时间:</label></td>
                                    <td><input id="eDate" name="endTime" class="form-control" type="date" required></td>
                                </tr>
                                <tr>
                                    <td><label>执行人员:</label></td>
                                    <td><select id="staff" name="repairman" class="form-control"></select></td>
                                    <td><label>任务状态:</label></td>
                                    <td><select id="status" name="status" class="form-control"> </select></td>
                                </tr>
                                <!-- <tr>
                                    <td><label>修改时间:</label></td>
                                    <td><input id="cTime" name="notesTime" class="form-control" type="text" disabled>
                                    </td>
                                    <td><label>备注:</label></td>
                                    <td><input id="notes" name="notes" class="form-control" type="text" disabled></td>
                                </tr> -->
                                <tr>
                                    <td style="vertical-align: top;"><label>任务描述:</label></td>
                                    <td><textarea id="detail" name="plan" class="form-control" rows="4"
                                            placeholder="任务描述"></textarea>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="center-block">
                        <button id="submit" type="button" class="btn btn-success" data-dismiss="modal">提交</button>
                        <button id="cancel" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 查询计划 -->
    <div id="sPlan" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">查询任务计划</h4>
                </div>
                <div id="sPlanModal" class="modal-body">
                    <form id="sPlanForm" class="form-inline">
                        <p>
                            <label>任务名称：</label>
                            <input id="sTitle" class="form-control" type="text">
                            <label>归属任务：</label>
                            <select id="sSubtask" class="form-control"></select>
                        </p>
                        <p>
                            <label>任务内容：</label>
                            <input id="sDetail" class="form-control" type="text">
                            <label>任务状态：</label>
                            <select id="sStatus" class="form-control"></select>
                        </p>
                        <p>
                            <label>时间范围：</label>
                            <input id="ssDate" class="form-control" type="date">
                            至
                            <input id="seDate" class="form-control" type="date">
                        </p>
                        <p>
                            <label>执行人员：</label>
                            <select id="sStaff" class="form-control"></select>
                        </p>
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="center-block">
                        <button id="search" type="button" class="btn btn-success" data-dismiss="modal">查询</button>
                        <button id="cancel" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 弹框内容结束 -->

    <!-- 方法渲染表格 -->
    <script type="text/html" id="toolbarDemo">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm" lay-event="addPlan">新增计划</button>
    <button class="layui-btn layui-btn-sm" lay-event="searchPlan">查询计划</button>
  </div>
</script>

    <script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

    <script src="js/layui.js" charset="utf-8"></script>

    <script>
        layui.use('table', function () {
            var table = layui.table;

            table.render({
                elem: '#pTable'
                , url: serverUrl + '/GetMonth'
                , where: { loginName: userName }
                , toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
                , defaultToolbar: ['filter', 'exports', 'print']
                , title: '用户数据表'
                , cols: [[
                    { type: 'checkbox', fixed: 'left' }
                    , { field: 'id', title: 'ID', width: 80, fixed: 'left', unresize: true, sort: true, templet: function (res) { return res.monthlyScheduleId } }
                    , { field: 'title', title: '任务名', width: 100, edit: 'text', templet: function (res) { return res.monthNo } }
                    , { field: 'subtask', title: '归属子任务', width: 120, sort: true, templet: function (res) { return res.subtaskNo } }
                    , { field: 'sDate', title: '开始时间', width: 110, sort: true, templet: '<div>{{d.startTime}}</div>' }
                    , { field: 'eDate', title: '结束时间', width: 110, sort: true, templet: '<div>{{d.endTime}}</div>' }
                    , { field: 'staff', title: '执行人员', width: 120, templet: '<div>{{d.repairman}}</div>' }
                    , { field: 'detail', title: '任务描述', templet: '<div>{{d.plan}}</div>' }
                    , { field: 'status', title: '任务状态', width: 110, sort: true }
                    , { field: 'cTime', title: '反馈时间', width: 110, sort: true, templet: '<div>{{d.notesTime}}</div>' }
                    , { field: 'notes', title: '备注', width: 80 }
                    , { fixed: 'right', title: '操作', toolbar: '#barDemo', width: 120 }
                ]]
                , page: true
            });

            //头工具栏事件
            table.on('toolbar(pTable)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                switch (obj.event) {
                    case 'addPlan':
                        addModal();
                        break;
                    case 'searchPlan':
                        searchModal();
                        break;
                };
            });

            //监听行工具事件
            table.on('tool(pTable)', function (obj) {
                var data = obj.data;
                //console.log(obj)
                if (obj.event === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                    });
                } else if (obj.event === 'edit') {
                    editModal(data);
                    // layer.alert(JSON.stringify(data));
                    // layer.prompt({
                    //     formType: 2
                    //     , value: data.email
                    // }, function (value, index) {
                    //     obj.update({
                    //         email: value
                    //     });
                    //     layer.close(index);
                    // });
                }
            });
        });
    </script>

</body>

</html>