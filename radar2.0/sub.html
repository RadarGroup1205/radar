<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>子任务信息界面</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="js/jquery.js"></script>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="css/tablestyle.css">
  <script src="js/bootstrap.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/jquery.dataTables.min.css">
  <script src="js/jquery.dataTables.js"></script>
  <script src="layui/layui.js"></script>
  <!--<script src ="../js/table.js" ></script>-->
</head>
<body>
  
  <section class="content">
    <div class="btn-group operation" >
      <button id="btn_add" type="button" class="btn bg-primary">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
      </button>
      <button id="btn_edit" type="button" class="btn bg-info">
        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改
      </button>
      <button id="btn_delete" type="button" class="btn btn-danger">
        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
      </button>
      <button id="btn_detail" type="button" class="btn btn-success" tab-name= "detail" tab-layid ="22" tab-url="taskTable">
        <span class="glyphicon glyphicon-detail" aria-hidden="true">
        </span>查看详情
      </button>
    </div>

    <div class="modal fade" id="addTask" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">添加维修设备信息</h4>
          </div>
          <div id="addBookModal" class="modal-body">
            <div class="form-horizontal">
              <div class="form-group">
                <label for="radarmaintenanceId" class="col-sm-2 control-label">radarmaintenanceId:*</label>
                <div class="col-sm-10">
                  <input class="form-control" id="1" type="text">
                </div>
              </div>
              <div class="form-group">
                <label for="设备编号" class="col-sm-2 control-label">设备编号:*</label>
                <div class="col-sm-10">
                  <input class="form-control" id="2" type="text">
                </div>
              </div>
              <div class="form-group">
                <label for="设备名称" class="col-sm-2 control-label">设备名称:*</label>
                <div class="col-sm-10">
                  <input class="form-control" id="3" type="text">
                </div>
              </div>
              <div class="form-group">
                <label for="任务编号" class="col-sm-2 control-label">任务编号:*</label>
                <div class="col-sm-10">
                  <input class="form-control" id="4" type="text">
                </div>
              </div>
              <div class="form-group">
                <label for="故障原因" class="col-sm-2 control-label">故障原因:*</label>
                <div class="col-sm-10">
                  <input class="form-control" id="5" type="text">
                </div>
              </div>
              <div class="form-group">
                <label for="解决方法" class="col-sm-2 control-label">解决方法:*</label>
                <div class="col-sm-10">
                  <input class="form-control" id="6" type="text">
                </div>
              </div>
              <div class="form-group">
                <label for="维修人" class="col-sm-2 control-label">维修人:*</label>
                <div class="col-sm-10">
                  <input class="form-control" id="7" type="text">
                </div>
              </div>
              <div class="form-group">
                <label for="维修人工号" class="col-sm-2 control-label">维修人工号:*</label>
                <div class="col-sm-10">
                  <input class="form-control" id="8" type="text">
                </div>
              </div>

              <div class="form-group">
                <label for="维修进度" class="col-sm-2 control-label">维修进度:*</label>
                <div class="col-sm-10">
                    <input class="form-control" list="browsers" id="9" type="text">
                    <datalist id="browsers">
                        <option value="待维修">
                        <option value="未维修">
                        <option value="维修完成">
                    </datalist>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="center-block">
              <button id="addRadarInfo" type="button" class="btn btn-success" data-dismiss="modal">保存</button>
              <button id="cancelAdd" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
              <!--<button id="onload" type="button"  data-dismiss="modal" onclick="getUser()">上传</button>-->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="editBookInfo" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h4 class="modal-title">修改维修任务内容</h4>
            </div>
            <div id="editBookModal" class="modal-body">
              <div class="form-horizontal">
                <div class="form-group">
                  <label for="1" class="col-sm-2 control-label">任务编号:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e1" type="text">
                  </div>
                </div>
                <div class="form-group">
                  <label for="2" class="col-sm-2 control-label">任务名称:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e2" type="text">
                  </div>
                </div>
                <div class="form-group">
                  <label for="3" class="col-sm-2 control-label">维修设备名称:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e3" type="text">
                  </div>
                </div>
                <div class="form-group">
                  <label for="4" class="col-sm-2 control-label">维修设备编号:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e4" type="text">
                  </div>
                </div>
                <div class="form-group">
                  <label for="5" class="col-sm-2 control-label">任务开始时间:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e5" type="text">
                  </div>
                </div>
                <div class="form-group">
                  <label for="6" class="col-sm-2 control-label">任务维修周期:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e6" type="text">
                  </div>
                </div>
                <div class="form-group">
                  <label for="7" class="col-sm-2 control-label">负责部门:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e7" type="text">
                  </div>
                </div>
                <div class="form-group">
                  <label for="8" class="col-sm-2 control-label">负责人:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e8" type="text">
                  </div>
                </div>
                <div class="form-group">
                  <label for="9" class="col-sm-2 control-label">任务状态:*</label>
                  <div class="col-sm-10">
                    <input class="form-control" id="e9" type="text">
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <div class="center-block">
                <button id="saveEdit" type="button" class="btn btn-success" data-dismiss="modal">保存</button>
                <button id="cancelEdit" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    <div class="modal fade" id="deleteBook" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">确认要删除吗？</h4>
          </div>
          <div class="modal-footer">
            <button id="delete" type="button" class="btn btn-danger" data-dismiss="modal">删除</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
          </div>
        </div>
      </div>
    </div>

    <!--查看详情页面 -->
    <div class="modal fade" id="subtaskDetail" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div id="subtaskDetailModel" class="modal-body">
            <div class="form-horizontal">
              <table id="subtasktable">
                <thead>
                  <tr>
                    <th>Id</th>
                    <th>子任务编号</th>
                    <th>主任务编号</th>
                    <th>零部件编号</th>
                    <th>零部件名称</th>
                    <th>维修人</th>
                    <th>维修人工号</th>
                    <th>子任务状态</th>
                  </tr>
                </thead>
             </table>
            </div>
          </div>
          <!-- <div class="modal-footer">
            <div class="center-block">
              <button id="addRadarInfo" type="button" class="btn btn-success" data-dismiss="modal">保存</button>
              <button id="cancelAdd" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            </div>
          </div> -->
        </div>
      </div>
    </div>

    <table id="任务基本属性" class="table table-striped table-bordered row-border hover order-column" cellspacing="0" width="100%">
      <thead>
        <tr>
          <th>任务编号</th>
          <th>设备名称</th>
          <th>负责人</th>
          <th>所属部门</th>
          <th>计划开始时间</th>
          <th>计划结束时间</th>
          <th>实际开始时间</th>
          <th>实际结束时间</th>
          <th>维修进度</th>
          <th>成本费用</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</body>
<script>
    $(function () {
      try {
        var strName = sessionStorage.getItem('userName');
        var numType = Number(sessionStorage.getItem('userType'));
        var strType = '用户';
        switch (numType) {
          case 0:
            strType = '超级管理员';
            break;
          case 1:
            strType = '主任务管理员';
            break;
          case 2:
            strType = '子任务管理员';
            var btn_add = document.getElementById('btn_add');                // 隐藏主任务维修表的添加按钮
            var btn_del = document.getElementById('btn_delete');             // 隐藏主任务维修表的删除按钮
            btn_add.style.display = 'none';
            btn_del.style.display = 'none';
            break;
          case 3:
            strType = '维修人员';
            break;
          default:
            alert('没有此用户类型' + numType);
        }
        var strMsg = strName + '[' + strType + ']'
        $("#user").html(strMsg);
      }
      catch (ex) {
        alert(ex.message);
      }
      });

  let serveUrl = 'http://10.222.6.46:8080/radar_db'
  var titles = ['任务编号', '任务名称', '维修设备名称', '维修设备编号', '任务开始时间','任务维修周期','负责部门','负责人','任务状态']

  var str = location.search
  if (str.indexOf("?") != -1) { //判断search是否存在
                        var str = str.substr(1);
                    }else{
                        var str = '0';
                    }
  console.log(str);

  function subtaskdata(value) {
    console.log("成功执行函数");
    var value = [];
    $.ajax({
        url: serveUrl+ "/SubSelect",
        type:"post",
        data:{id:str},
        dataType:"json",
        async:false, // 同步请求
        success:function(result){
            if(result != null && result != "" && result != undefined){
                var data_ = result.data;
                // console.log(data_)
                for(i in data_){
                  if(data_[i].taskNo == str){
                    value.push(data_[i]);
                  }else if(str == '0'){
                    value = data_;
            }
                }
            }
        },
        error:function(){
          console.log('请求子任务数据失败！')
        }
    }
    )
    return value;
  }
  data = subtaskdata();
  //console.log(data);

  $(function () {
    var table = $('#任务基本属性').DataTable({
      "data": data,
      "columns": [
                { "data": "subtaskNo" },
                { "data": "moduleName" },
                { "data": "supervisor" },
                { "data": "department" },
                { "data": "planStarttime" },
                { "data": "planEndtime" },
                { "data": "realStarttime" },
                { "data": "realEndtime" },
                { "data": "shedule" },
                { "data": "radarcost" },
              ],

      "pagingType": "full_numbers",
      "bSort": true,
      "language": {
        "sProcessing": "处理中...",
        "sLengthMenu": "显示 _MENU_ 项结果",
        "sZeroRecords": "没有匹配结果",
        "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
        "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
        "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
        "sInfoPostFix": "",
        "sSearch": "搜索:",
        "sUrl": "",
        "sEmptyTable": "表中数据为空",
        "sLoadingRecords": "载入中...",
        "sInfoThousands": ",",
        "oPaginate": {
            "sFirst": "首页",
            "sPrevious": "上页",
            "sNext": "下页",
            "sLast": "末页"
        },
        "oAria": {
            "sSortAscending": ": 以升序排列此列",
            "sSortDescending": ": 以降序排列此列"
        }
      },
      "columnDefs": [
      {
        "searchable": false,
        "orderable": true,
        "targets": 0
      },
      {
          "targets":1,
          "render": function ( data, type, row, meta) {
              if(type === 'display'){         
                  data = '<a href="javascript:void(0);" class = "btn_detail">' + data + '</a>';               
              }

              return data;
          }
          
      },
     ],
      "order": [[1, 'asc']]
      
    });
    //table.on('order.dt search.dt', function() {
    //  table.column(0, {
    //   search: 'applied',
    //    order: 'applied'
    //  }).nodes().each(function(cell, i) {
    //    cell.innerHTML = i + 1;
    // });
    //}).draw();    //  第一列变成了顺序编号

    $('#任务基本属性 tbody').on('click', 'tr', function () {
      if ( $(this).hasClass('selected') ) {
        $(this).removeClass('selected');
      }
      else {
        table.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
      }
    });

    // $('#任务基本属性 tbody').on('dblclick', 'tr', function () {
    //   console.log(table.rows('.selected').data()[0].subtaskNo);
    // var subtaskno = table.rows('.selected').data()[0].subtaskNo
    // layui.use(['element','jquery'], function () {
    //     var element=parent.layui.element;
    //     //获取父级页面
    //     element.tabAdd('tabList',{
    //         title:subtaskno + "零部件维修任务详情",
    //         content:'<iframe id="iframeMain" style="width: 100%" ; height="1000px" ; scrolling="no" frameborder="no" src="part.html?'+subtaskno+'"></iframe>',
    //         id:subtaskno //lay-id的值
    //     })
    //     element.tabChange('tabList',subtaskno)

    //    })
    // });

    $('#任务基本属性 tbody').on('click','td',function(event){
      // console.log(table.rows('.selected').data()[0].taskNo);
      for(let row of table.context[0].aoData){
        if(row._aData.moduleName == event.target.innerHTML){
          console.log('????????',row._aData.subtaskNo);
          var subtaskno = row._aData.subtaskNo;
          layui.use(['element','jquery'], function () {
          let element=parent.layui.element;
          //获取父级页面
          element.tabAdd('tabList',{
              title:subtaskno+ "子任务详情",
              content:'<iframe id="iframeMain" style="width: 100%"; height="1000px";  scrolling="no" frameborder="no" src="part.html?'+subtaskno+'"></iframe>',
              id: subtaskno //lay-id的值
          })
          element.tabChange('tabList',subtaskno)

           })
        };
      };
      console.log(table.context[0].aoData[0]._aData);
      console.log(event.target.parentElement.previousElementSibling.innerHTML)
      // if(event.target.parentElement.previousElementSibling.innerHTML == "")

    });



    $("#btn_add").click(function () {
      console.log('add');
      $("#addTask").modal({backdrop: 'static', keyboard: false})  // 当用户点击模态框外部时不会关闭模态框
      //获得服务器当前时间并设为初始值
      var time = new Date();
      var year = time.getFullYear();
      var month = ("0" + (time.getMonth() + 1)).slice(-2);
      var day = ("0" + time.getDate()).slice(-2);
      var today = year + "-" + (month) + "-" + (day);
      $("#pStartTime").attr("min", today);
      $('#pStartTime').val(today);
      $('#pEndTime').val(today);
      var Tasknum = 'T0000' +  (table.column(0).data().length + 1);// 计算 新增的 任务编号
      $('#taskNo').val(Tasknum);
    });


    $("#cancelAdd").on('click', function() {
      console.log('cancelAdd');
      $("#addBookModal").find('input').val('')
    })

    $("#addRadarInfo").click(
    function(){
      $.ajax({
          url:  "http://127.0.0.1:8081/login",                                          //后台提供的服务器（接口） config.baseServerUrl + '/account/login', 
          type: 'post',                                               //请求方式是post
          data: { radarmaintenanceId: document.getElementById("1").value, 
                  radarNo: document.getElementById("2").value, 
                  radarName: document.getElementById("3").value,
                  taskNo: document.getElementById("4").value,
                  faultReason: document.getElementById("5").value,
                  solution: document.getElementById("6").value, 
                  serviceman: document.getElementById("7").value,
                  servicemanNo: document.getElementById("8").value,
                  schedule: document.getElementById("9").value},

      });
          var radarmaintenanceId = $("#1").val().toString()
          var 任务名称 = $("#2").val()
          var 维修设备名称 = $("#3").val()
          var 维修设备编号 = $("#4").val()
          var 任务开始时间 = $("#5").val()
          var 任务维修周期 = $("#6").val()
          var 负责部门 = $("#7").val()
          var 负责人 = $("#8").val()
          var 任务状态 = $("#9").val()
          table.row.add([radarmaintenanceId, 任务名称, 维修设备名称, 维修设备编号, 任务开始时间, 任务维修周期,负责部门 ,负责人,任务状态]).draw();
    }
    );


    $("#btn_add").click(function(){
      console.log('add');
      $("#addBook").modal()
    });

    $('#btn_edit').click(function () {
      console.log('edit');
      if (table.rows('.selected').data().length) {
        $("#editBookInfo").modal()
        var rowData = table.rows('.selected').data()[0];
        //console.log(rowData)
        var inputs = $("#editBookModal").find('input')
        var count1=0
        for (var key in rowData){
          $(inputs[count1]).val(rowData[key])
          count1++
        }
        // for (var i = 0; i < inputs.length; i++) {
        //   $(inputs[i]).val(rowData[i + 1])
        // }
      } else {
        alert('请选择项目');
      }
    });

    $("#saveEdit").click(function() {
      var editBookName = $("#editBookName").val()
      var editBookAuthor = $("#editBookAuthor").val()
      var editBookPrice = $("#editBookPrice").val()
      var editBookPublish = $("#editBookPublish").val()
      var editBookISBN = $("#editBookISBN").val()
      var newRowData = [].concat(editBookName, editBookAuthor, editBookPrice, editBookPublish, editBookISBN);
      var tds = Array.prototype.slice.call($('.selected td'))
      for (var i = 0; i < newRowData.length; i++) {
        if (newRowData[i] !== '') {
          tds[i + 1].innerHTML = newRowData[i];
        } else {
          alert(titles[i] + '内容不能为空')
        }
      }    
    })

    $("#cancelEdit").click(function() {
      console.log('cancelAdd');
      $("#editBookModal").find('input').val('')
    })

    $('#btn_delete').click(function () {
      if (table.rows('.selected').data().length) {
        $("#deleteBook").modal()
      } else {
        alert('请选择项目');
      }
    });

    $('#delete').click(function () {
      console.log(table.rows('.selected').data()[0].radarmaintenanceId)
      $.ajax({
        type:"post",
            url:"http://127.0.0.1:8081/delete",
            async:true,
            data:{
                datalength:table.rows('.selected').data().length,
                deldata: table.rows('.selected').data()[0].radarmaintenanceId
      }
      }
      )
      table.row('.selected').remove().draw(false);


    });

    
    
    $('#btn_detail').click(function () {
    console.log(table.rows('.selected').data()[0].subtaskNo);
    var subtaskno = table.rows('.selected').data()[0].subtaskNo
    layui.use(['element','jquery'], function () {
        let element=parent.layui.element;
        //获取父级页面
        element.tabAdd('tabList',{
            title:subtaskno + "零部件维修任务详情",
            content:'<iframe id="iframeMain" style="width: 100%" ; height="1000px" ; scrolling="no" frameborder="no" src="part.html?'+subtaskno+'"></iframe>',
            id:subtaskno //lay-id的值
        })
        element.tabChange('tabList',subtaskno)

       })
    });
  })
</script>

</html>